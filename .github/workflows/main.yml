name: Deploy to AWS Spot Instances

on:
  push:
    branches:
      - main  # Adjust this as necessary for your workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    # - name: Configure AWS Credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: ${{ secrets.AWS_REGION }}

    # - name: Request EC2 Spot Instance
    #   id: request-spot
    #   run: |
    #     INSTANCE_ID=$(aws ec2 request-spot-instances \
    #       --spot-price "0.03" \
    #       --instance-count 1 \
    #       --type "one-time" \
    #       --launch-specification file://.github/workflows/spot-instance-spec.json \
    #       --query 'SpotInstanceRequests[0].InstanceId' \
    #       --output text)
    #     echo "::set-output name=INSTANCE_ID::$INSTANCE_ID"
      
    -  name: Deploy to Spot instance
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          REMOTE_HOST: ${{ secrets.HOST_IP }}
          REMOTE_USER: ${{ secrets.HOST_NAME}}

      - name: Executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.HOST_NAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo apt-get -y update
            sudo apt-get install -y apache2
            sudo systemctl start apache2
            sudo systemctl enable apache2
            cd home
            sudo mv * /var/www/html
